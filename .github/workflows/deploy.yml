name: Build and Deploy to Server

on:
  push:
    branches:
      - main

jobs:
  build-and-uat:
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Type check
        run: npm run typecheck

      - name: Build app
        run: npm run build
        env:
          VITE_GOOGLE_CLIENT_ID: ${{ secrets.VITE_GOOGLE_CLIENT_ID }}
          VITE_GOOGLE_API_KEY: ${{ secrets.VITE_GOOGLE_API_KEY }}

      - name: Deploy to UAT
        run: |
          echo "Deploying to UAT environment..."
          # Create a temporary script to handle the deployment
          cat > deploy.sh << 'EOF'
          #!/bin/bash
          set -e
          
          # Clean and create directory
          rm -rf /home/beny/gtask-uat/*
          mkdir -p /home/beny/gtask-uat
          
          # Copy files
          cp package.json /home/beny/gtask-uat/
          cp package-lock.json /home/beny/gtask-uat/
          cp -r dist /home/beny/gtask-uat/
          
          # Install dependencies
          cd /home/beny/gtask-uat
          npm ci
          
          # Kill any existing process
          lsof -ti:3001 | xargs kill -9 2>/dev/null || true
          
          # Start server
          nohup npm run preview -- --host 0.0.0.0 --port 3001 > /dev/null 2>&1 &
          
          # Wait for server to start
          sleep 5
          
          # Check if server is running
          if curl -s http://localhost:3001 > /dev/null; then
            echo "UAT server is running successfully!"
          else
            echo "UAT server failed to start!"
            exit 1
          fi
          EOF
          
          # Make script executable and run it
          chmod +x deploy.sh
          ./deploy.sh
          
          echo "UAT deployment complete! Please verify at http://192.168.1.244:3001"

  wait-for-approval:
    needs: build-and-uat
    runs-on: self-hosted
    steps:
      - name: Wait for manual approval
        uses: trstringer/manual-approval@v1
        with:
          secret: ${{ github.token }}
          approvers: beny
          minimum-approvals: 1

  deploy-to-production:
    needs: wait-for-approval
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Build app
        run: npm run build
        env:
          VITE_GOOGLE_CLIENT_ID: ${{ secrets.VITE_GOOGLE_CLIENT_ID }}
          VITE_GOOGLE_API_KEY: ${{ secrets.VITE_GOOGLE_API_KEY }}

      - name: Deploy to Production
        run: |
          echo "Copying files to production server..."
          # Create a temporary script to handle the deployment
          cat > deploy.sh << 'EOF'
          #!/bin/bash
          set -e
          
          # Clean and create directory
          rm -rf /home/beny/gtask/*
          mkdir -p /home/beny/gtask
          
          # Copy files
          cp package.json /home/beny/gtask/
          cp package-lock.json /home/beny/gtask/
          cp -r dist /home/beny/gtask/
          
          # Install dependencies
          cd /home/beny/gtask
          npm ci
          
          # Kill any existing process
          lsof -ti:3000 | xargs kill -9 2>/dev/null || true
          
          # Start server
          nohup npm run preview -- --host 0.0.0.0 --port 3000 > /dev/null 2>&1 &
          
          # Wait for server to start
          sleep 5
          
          # Check if server is running
          if curl -s http://localhost:3000 > /dev/null; then
            echo "Production server is running successfully!"
          else
            echo "Production server failed to start!"
            exit 1
          fi
          EOF
          
          # Make script executable and run it
          chmod +x deploy.sh
          ./deploy.sh
          
          echo "Production deployment complete!" 